<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Puppet Class: aix_tidy::nfs_options
  
    &mdash; Documentation by YARD 0.9.12
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "puppet_classes::aix_tidy::nfs_options";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../puppet_class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (a)</a> &raquo;
    <span class='title'><span class='object_link'>Puppet Classes</span></span>
     &raquo; 
    <span class="title">aix_tidy::nfs_options</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="puppet_class_list_link"
        href="../puppet_class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Puppet Class: aix_tidy::nfs_options</h1>
<div class="box_info">
  
  
  <dl>
    <dt>Defined in:</dt>
    <dd>
      manifests/nfs_options.pp
    </dd>
  </dl>
</div>

<h2>Overview</h2>
<div class="docstring">
  <div class="discussion">
    
<p>Aix_tidy::Nfs_options</p>

<p>Make sure NFS filesystems are mounted correctly * enforce specific set of
options for all mounts * remove all instances of localhost and $fqdn from
the exports file</p>

  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;rw,bg,hard,intr,nosuid,sec=sys&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Options force these options to exist for every NFS mount in its
/etc/filesystems entry</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>default_root_squash</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;-2&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Value to set root_squash to if the entry is missing or not allowed</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>default_authentication</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;sys&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Value to set sec to if entry is missing or invalid</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>allowed_root_squash_re</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;-2|-1&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Quoted regular expression matching allowed values for the root_squash
option</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>allowed_security_methods_re</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;sys|dh|krb5|krb5p&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Quoted regular expression matching allowed values for the sec option</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>manage_nfs_mounts</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>True to enfoce the NFS mount options in /etc/filesystems else do nothing</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>manage_local_alias</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>True to remove localhost and its aliases from the allow option else do
nothing</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>manage_missing_access</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>True to disable any entries that do not contain an access option otherwise
do nothing</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>manage_root_squash</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>True to fix any entries that are missing the root_squash option otherwise
do nothing</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>manage_security</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>True to fix any entries that are missing the sec option otherwise do
nothing</p>
</div>
      
    </li>
  
</ul>


</div><div class="method_details_list">
  <table class="source_code">
    <tr>
      <td>
        <pre class="lines">


27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162</pre>
      </td>
      <td>
        <pre class="code"><span class="info file"># File 'manifests/nfs_options.pp', line 27</span>

class aix_tidy::nfs_options(
  String  $options                      = &quot;rw,bg,hard,intr,nosuid,sec=sys&quot;,
  String  $default_root_squash          = &quot;-2&quot;,
  String  $default_authentication       = &quot;sys&quot;,
  String  $allowed_root_squash_re       = &quot;-2|-1&quot;,
  String  $allowed_security_methods_re  = &quot;sys|dh|krb5|krb5p&quot;,
  Boolean $manage_nfs_mounts            = true,
  Boolean $manage_local_alias           = true,
  Boolean $manage_missing_access        = true,
  Boolean $manage_root_squash           = true,
  Boolean $manage_security              = true,
) {

  $exports = &quot;/etc/exports&quot;
  $replace_exports = &quot; &gt; ${exports}.tmp &amp;&amp; mv ${exports}.tmp ${exports} &amp;&amp; chgrp system ${exports}&quot;

  if $manage_nfs_mounts {
    $nfs_mounts = dig($facts, &#39;mountpoints&#39;).then | $mountpoints | {
      $mountpoints.filter |$index, $values| {
        $values[&#39;filesystem&#39;] =~ &quot;nfs&quot;
      }.map |$index, $value| {
        $index
      }
    }

    # enforce correct options for all nfs mounts
    if $nfs_mounts {
      mount { $nfs_mounts:
        options =&gt; $options,
      }
    }
  }
  # Ensure we have an exports file to work on...
  file { $exports:
    ensure =&gt; file,
    owner  =&gt; &quot;root&quot;,
    group  =&gt; &quot;system&quot;,
    mode   =&gt; &quot;0644&quot;,
  }

  if $manage_local_alias {
    # remove all instances of &#39;localhost&#39; and $fqdn from access= attribute in
    # /etc/exports - can&#39;t do this with augeas since AIX has its own whacked
    # exports format (sigh)
    $local_names_re = &quot;(localhost|${facts[&#39;fqdn&#39;]}|${facts[&#39;hostname&#39;]})&quot;
    $remove_localhost_alias =
  &quot;awk &#39;{
  if (match(\$0, /[^#].*access.*${$local_names_re}:?*/))
  	gsub(/${local_names_re}:?/, \&quot;\&quot;, \$0);
  print \$0
  }&#39; ${exports} ${replace_exports}&quot;

    exec { &quot;${exports} disable localhost alias&quot;:
      command =&gt; $remove_localhost_alias,
      onlyif  =&gt; &quot;grep -E &#39;^[^#].*access=.*${local_names_re}.*&#39; ${exports}&quot;,
      path    =&gt; [ &#39;/usr/bin&#39;, &#39;/bin&#39;],
      notify  =&gt; Exec[&quot;exportfs&quot;],
      require =&gt; File[$exports]
    }
  }

  if $manage_missing_access {
    # disable all hosts entries lines without explicit access rules
    $comment_no_access =
  &quot;awk &#39;{ if (match(\$0, /[^#].*access=.*/))
  	print \$0
  else
  	print \&quot;#\&quot; \$0
  }&#39; ${exports} ${replace_exports}&quot;

    exec { &quot;${exports} disable missing access&quot;:
      command =&gt; $comment_no_access,
      onlyif  =&gt; &quot;grep -E &#39;^[^#]+&#39; ${exports} | grep -E -v &#39;.*access=.*&#39;&quot;,
      path    =&gt; [ &#39;/usr/bin&#39;, &#39;/bin&#39;],
      notify  =&gt; Exec[&quot;exportfs&quot;],
      require =&gt; File[&quot;/etc/exports&quot;],
    }
  }

  if $manage_root_squash {
    # Ensure the root_squash option is set to -2 or -1 for each entry
    $fix_root_squash =
  &quot;awk &#39;{
    if (match(\$0, /[^#].*root_squash=(${allowed_root_squash_re}).*/)) {
    	print \$0
    } else {
      gsub(/,?root_squash=[^,]*/, \&quot;\&quot;, \$2)
      printf \$1 \&quot;\\t\&quot; \&quot;root_squash=${default_root_squash}\&quot;
      if (match(\$2, /\\w/)) {
        printf \&quot;,\&quot; \$2
      }
      printf \&quot;\\n\&quot;
    }
  }&#39; ${exports} ${replace_exports}&quot;
    exec { &quot;${exports} enforce root squash&quot;:
      command =&gt; $fix_root_squash,
      onlyif  =&gt; &quot;grep -E &#39;^[^#].*root_squash=(${allowed_root_squash_re}).*&#39; ${exports}&quot;,
      path    =&gt; [ &#39;/usr/bin&#39;, &#39;/bin&#39;],
      notify  =&gt; Exec[&quot;exportfs&quot;],
      require =&gt; File[&quot;/etc/exports&quot;],
    }

  }

  if $manage_security {
    # Ensure the security option is set for each entry
    $fix_sec =
    &quot;awk &#39;{
      if (match(\$0, /[^#].*sec=(${allowed_security_methods_re}).*/)) {
      	print \$0
      } else {
        gsub(/,?sec=[^,]*/, \&quot;\&quot;, \$2)
        printf \$1 \&quot;\\t\&quot; \&quot;sec=${default_authentication}\&quot;
        if (match(\$2, /\\w/)) {
          printf \&quot;,\&quot; \$2
        }
        printf \&quot;\\n\&quot;
      }
    }&#39; ${exports} ${replace_exports}&quot;

    exec { &quot;${exports} enforce security method&quot;:
      command =&gt; $fix_sec,
      onlyif  =&gt; &quot;grep -E &#39;^[^#]+&#39; ${exports} | grep -E -v &#39;.*sec=(${allowed_security_methods_re}).*&#39;&quot;,
      path    =&gt; [&#39;/usr/bin&#39;, &#39;/bin&#39;],
      notify  =&gt; Exec[&quot;exportfs&quot;],
      require =&gt; File[&quot;/etc/exports&quot;],
    }

  }

  exec { &quot;exportfs&quot;:
    command     =&gt; &quot;exportfs -a&quot;,
    refreshonly =&gt; true,
    path        =&gt; [&#39;/usr/sbin&#39;, &#39;/sbin&#39;, &#39;/usr/bin&#39;, &#39;/bin&#39;],
  }
}</pre>
      </td>
    </tr>
  </table>
</div>
</div>

      <div id="footer">
     Generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>.
</div>

    </div>
  </body>
</html>